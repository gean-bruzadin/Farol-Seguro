@model Farol_Seguro.Models.Denuncia

@{
    ViewData["Title"] = "Nova Denúncia";
}

<link href="~/css/header.css" rel="stylesheet" />
<link href="~/css/denuncia.css" rel="stylesheet" />
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css" integrity="sha512-..." crossorigin="anonymous" />

@* REFERÊNCIA SELECT2 CSS ADICIONADA/DESCOMENTADA *@
<link href="https://cdn.jsdelivr.net/npm/select2@4.1.0-rc.0/dist/css/select2.min.css" rel="stylesheet" />
@* FIM REFERÊNCIA SELECT2 CSS *@

<style>

    /* Estilos relacionados ao file upload (mantidos) */
        .file-upload-container {
                position: relative;
                overflow: hidden;

    }

                .file-upload-container input[type="file"] {
                        position: absolute;
                        top: 0;
                        left: 0;
                        width: 100%;
                        height: 100%;
                        opacity: 0;
                        cursor: pointer;
                        z-index: 1;

        }

        .anexos-display, .anexos-display button {
                position: relative;
                z-index: 20;

    }
</style>

@* =======================================================
    BLOCO PARA EXIBIR MENSAGENS DE ALERTA (SUCESSO/ERRO)
======================================================== *@
@{
    if (TempData["MensagemSucesso"] != null)
    {
        <div class="alert alert-success alert-dismissible fade show" role="alert">
            <strong>Sucesso!</strong> @TempData["MensagemSucesso"]
            <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
        </div>
    }
    else if (TempData["MensagemErro"] != null)
    {
        <div class="alert alert-danger alert-dismissible fade show" role="alert">
            <strong>Erro!</strong> @TempData["MensagemErro"]
            <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
        </div>
    }
}
@* =======================================================
    FIM DO BLOCO DE MENSAGENS
======================================================== *@


<div class="form_section">
    <h2 class="form-section-title">
        <i class="fas fa-info-circle"></i> Informações Básicas
    </h2>

    <form asp-action="Criar" enctype="multipart/form-data">
        <div asp-validation-summary="ModelOnly" class="text-danger"></div>
        @Html.AntiForgeryToken()

        <div class="form-group">
            <label for="Titulo_Denuncia">Título da Denúncia</label>
            <input asp-for="Titulo_Denuncia" class="form-control" placeholder="Ex: Bullying na sala 3" />
            <span asp-validation-for="Titulo_Denuncia" class="text-danger"></span>
        </div>

        <div class="form-row">
            <div class="form-col">
                <div class="form-group">
                    <label asp-for="Categoria_Denuncia" class="form-label">Categoria</label>
                    <select asp-for="Categoria_Denuncia" class="form-control" required>
                        <option value="">Selecione uma categoria</option>
                        <option value="Verbal">Bullying Verbal</option>
                        <option value="Social">Bullying Social</option>
                        <option value="Físico">Bullying Físico</option>
                        <option value="Cyber">Cyberbullying</option>
                        <option value="Outro">Outro</option>
                    </select>
                    <span asp-validation-for="Categoria_Denuncia" class="text-danger"></span>
                </div>
            </div>

            @* CAMPO NOVO: Data e Hora do Ocorrido (Não Mapeado no Model) *@
            <div class="form-col">
                <div class="form-group">
                    <label class="form-label" for="DataIncidenteCampo">Dia e Hora do Ocorrido (Opcional)</label>
                    <input type="datetime-local" id="DataIncidenteCampo" name="DataIncidenteCampo" class="form-control" />
                    <div class="form-note"> 
                    </div>
                </div>
            </div>

        </div>

        <div class="form-check mb-3">
            <input asp-for="DenunciaAnonima" class="form-check-input" />
            <label asp-for="DenunciaAnonima" class="form-check-label">Denúncia Anônima</label>
        </div>

        @* CAMPO ESCOLA: Com classe para pesquisa (Select2) *@
        <div class="mb-3">
            <label asp-for="Id_Escola" class="form-label">Escola (Pesquisar/Selecionar)</label>
            @* A classe 'select-searchable' e o id 'selectEscola' são usados pelo JavaScript *@
            <select asp-for="Id_Escola" class="form-select select-searchable" id="selectEscola" asp-items="ViewBag.Id_Escola">
                <option value="">Pesquisar ou Selecionar a Escola...</option>
            </select>
            <span asp-validation-for="Id_Escola" class="text-danger"></span>
            <div class="form-note">Use a caixa de pesquisa no campo acima para encontrar a escola rapidamente.</div>
        </div>
        @* ---------------------------------------------------------------------- *@

        <div class="form-section">
            <h2 class="form-section-title">
                <i class="fas fa-align-left"></i> Descrição da Denúncia
            </h2>

            <div class="form-group">
                <label asp-for="Descricao_Denuncia" class="form-label">Descrição detalhada</label>
                <textarea asp-for="Descricao_Denuncia" class="form-control" id="descricao" placeholder="Descreva o incidente com o máximo de detalhes possível: o que aconteceu, onde, quando, quem estava envolvido..."></textarea>
                <span asp-validation-for="Descricao_Denuncia" class="text-danger"></span>
                <div class="form-note">Forneça informações claras e objetivas para facilitar a investigação.</div>
            </div>


            <div id="testemunhasContainer">
                <div class="form-group">
                    <label>Testemunhas</label>
                    <input type="text" name="Nome_Testemunha" placeholder="Nome da Testemunha 1 (Opcional)" class="form-control mb-1" />
                    <input type="text" name="Telefone_Testemunha" placeholder="Telefone da Testemunha 1" class="form-control" />
                    <div class="form-note">Se possível, identifique claramente quem são as pessoas envolvidas.</div>
                </div>
            </div>
            <button type="button" class="btn btn-secondary mb-3" onclick="adicionarTestemunha()">Adicionar Outra Testemunha</button>
        </div>

        <div class="form-section">
            <h2 class="form-section-title">
                <label for="arquivos" class="form-label"> <i class="fas fa-paperclip"></i> Anexos (Fotos, vídeos, áudios)</label>
            </h2>

            <div class="file-upload-container">
                <i class="fas fa-cloud-upload-alt"></i>
                <p>Arraste arquivos aqui ou clique para selecionar</p>

                <input type="file" name="anexosArquivos" class="form-control" id="arquivos" multiple />

                <div class="anexos-display">
                    <div class="form-note" id="fileNote">
                        Formatos aceitos: PDF, JPG, PNG, MP4, MP3 (Máx. 10MB por arquivo). **Opcional.**
                    </div>
                    <span id="fileNamesDisplay" class="mt-2 text-primary small"></span>
                </div>
            </div>
        </div>

        <button type="submit" class="btn-submit">Salvar Denúncia</button>
    </form>
</div>

@* --- JQUERY É NECESSÁRIO PARA O SELECT2 --- *@
<script src="https://code.jquery.com/jquery-3.7.1.min.js" integrity="sha256-/JqT3SQfawR3S/A3W/U/z5R5x5wWf5+5G5H5R5R5S50=" crossorigin="anonymous"></script>
@* REFERÊNCIA SELECT2 JS ADICIONADA/DESCOMENTADA *@
<script src="https://cdn.jsdelivr.net/npm/select2@4.1.0-rc.0/dist/js/select2.min.js"></script>
@* FIM REFERÊNCIA SELECT2 JS *@

<script src="~/js/menu_dropdown.js"></script>
<script src="~/js/open-modal.js"></script>
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>


<script>
    // =======================================================
    // INICIALIZAÇÃO DO SELECT2 PARA PESQUISA DE ESCOLA
    // =======================================================
    $(document).ready(function() {
        // Inicializa o Select2 no elemento que tem o ID 'selectEscola'
        $('#selectEscola').select2({
            placeholder: "Digite o nome da escola para pesquisar...",
            allowClear: true // Permite desmarcar a seleção
        });
    });
    // =======================================================


    let testemunhaCount = 1;
    const arquivosSelecionados = new DataTransfer();

    function adicionarTestemunha() {
        testemunhaCount++;
        var container = document.getElementById("testemunhasContainer");
        var div = document.createElement("div");
        div.classList.add("mb-2");
        div.innerHTML = `
            <hr class="mt-2 mb-2"/>
            <label>Testemunha ${testemunhaCount}</label>
            <input type="text" name="Nome_Testemunha" placeholder="Nome da Testemunha ${testemunhaCount} (Opcional)" class="form-control mb-1"/>
            <input type="text" name="Telefone_Testemunha" placeholder="Telefone da Testemunha ${testemunhaCount}" class="form-control"/>
        `;
        container.appendChild(div);
    }

    function removerAnexo(index) {
        arquivosSelecionados.items.remove(index);
        const fileInput = document.getElementById('arquivos');
        fileInput.files = arquivosSelecionados.files;
        renderizarListaAnexos(fileInput, document.getElementById('fileNote'), document.getElementById('fileNamesDisplay'));
    }

    function renderizarListaAnexos(fileInput, note, display) {
        if (fileInput.files.length > 0) {
            const fileCount = fileInput.files.length;
            let fileListHtml = `
                <i class="fas fa-check-circle text-success me-1"></i>
                <strong>${fileCount} arquivo(s) selecionado(s):</strong><br>
                <div class="list-group list-group-flush mt-2">
            `;

            Array.from(fileInput.files).forEach((file, index) => {
                fileListHtml += `
                    <div class="list-group-item d-flex justify-content-between align-items-center p-1">
                        <span class="small text-truncate me-2">${file.name}</span>
                        <button type="button" class="btn btn-danger btn-sm"
                                onclick="removerAnexo(${index})"
                                title="Remover anexo">
                            <i class="fas fa-trash-alt"></i>
                        </button>
                    </div>
                `;
            });

            fileListHtml += `</div>`;

            display.innerHTML = fileListHtml;
            note.style.display = 'none'; // Esconde a nota de formato
        } else {
            display.innerHTML = '';
            note.style.display = 'block'; // Mostra a nota de formato original
        }
    }


    document.getElementById('arquivos').addEventListener('change', function(e) {
        const fileInput = this;
        const note = document.getElementById('fileNote');
        const display = document.getElementById('fileNamesDisplay');

        // 1. ADICIONA OS NOVOS ARQUIVOS À VARIÁVEL GLOBAL
        Array.from(e.target.files).forEach(file => {
             arquivosSelecionados.items.add(file);
        });

        // 2. ATUALIZA O INPUT ORIGINAL COM A LISTA ACUMULADA
        fileInput.files = arquivosSelecionados.files;

        // 3. RENDERIZA A LISTA NA TELA
        renderizarListaAnexos(fileInput, note, display);
    });

</script>