@using System.Text.Json;
@{
    ViewData["Title"] = "Dashboard de Denúncias";

    // Dados iniciais carregados via C# (ViewBag)
    int[] mensalCriadas = ((int[])ViewBag.MensalCriadas) ?? new int[12];
    int[] mensalResolvidas = ((int[])ViewBag.MensalResolvidas) ?? new int[12];
    int[] mensalFalsas = ((int[])ViewBag.MensalFalsas) ?? new int[12];
    double[] mediaDiasPorMes = ((double[])ViewBag.MediaDiasPorMes) ?? new double[12];

    int anoSelecionado = ViewBag.AnoSelecionado ?? DateTime.Now.Year;

    // Dados KPI para o carregamento inicial
    var totalDenuncias = (int)ViewBag.Total;
    var totalInvestigadas = (int)ViewBag.Pendentes;
    var denunciasMes = (int)ViewBag.Mes;
    var mediaTempoDias = (string)ViewBag.MediaTempoResolucaoDias;
}

<link href="~/css/header.css" rel="stylesheet" />

<div class="container mt-4">
    <h2><i class="bi bi-graph-up-arrow"></i> Dashboard de Estatísticas</h2>

    <div class="d-flex gap-3 align-items-center mt-3 mb-2">
        <form id="filtroAno" class="d-flex gap-2 align-items-center">
            <label>Ano:</label>

            <select id="selectAno" name="ano" class="form-select w-auto">
                @for (int y = DateTime.Now.Year; y >= 2020; y--)
                {
                    @if (y == anoSelecionado)
                    {
                        <option value="@y" selected>@y</option>
                    }
                    else
                    {
                        <option value="@y">@y</option>
                    }
                }
            </select>

            <button type="button" id="btnAtualizar" class="btn btn-primary">Atualizar</button>
        </form>

        <div class="ms-auto">
            <button id="exportCsv" class="btn btn-outline-secondary">Exportar CSV</button>
            <button id="exportExcel" class="btn btn-outline-secondary">Exportar Excel</button>
        </div>
    </div>

    <hr />

    <div class="row">
        <div class="col-md-3 mb-3">
            <div class="card shadow h-100">
                <div class="card-body">
                    <h6>Total de Denúncias</h6>
                    <h3 id="kpi-total-denuncias">@totalDenuncias</h3>
                </div>
                <div class="card-footer"><small>Desde o início</small></div>
            </div>
        </div>

        @if (totalInvestigadas > 0)
        {
            <div class="col-md-3 mb-3" id="card-pendentes">
                <div class="card shadow h-100" style="background: linear-gradient(90deg,#fff3cd,#ffe8a1);">
                    <div class="card-body">
                        <h6>Pendentes de Resposta</h6>
                        <h3 id="kpi-pendentes">@totalInvestigadas</h3>
                    </div>
                    <div class="card-footer"><small>Aguardando ação</small></div>
                </div>
            </div>
        }

        <div class="col-md-3 mb-3">
            <div class="card shadow h-100" style="background: linear-gradient(90deg,#cff4fc,#bfefff);">
                <div class="card-body">
                    <h6>Denúncias no Mês</h6>
                    <h3 id="kpi-denuncias-mes">@denunciasMes</h3>
                </div>
                <div class="card-footer"><small id="kpi-denuncias-mes-rodape">@DateTime.Now.ToString("MMMM/yyyy")</small></div>
            </div>
        </div>

        <div class="col-md-3 mb-3">
            <div class="card shadow h-100" style="background: linear-gradient(90deg,#d1e7dd,#b6dfc9);">
                <div class="card-body">
                    <h6>Tempo Médio de Resolução</h6>
                    <h3 id="kpi-tempo-resolucao">@(string.IsNullOrEmpty(mediaTempoDias) ? "N/A" : mediaTempoDias)</h3>
                </div>
                <div class="card-footer"><small>Média anual até a conclusão</small></div>
            </div>
        </div>
    </div> @* Fechando a div.row *@

    <div class="row mt-4">
        <div class="col-md-10 offset-md-1">
            <div class="card p-3 shadow">
                <h5>Denúncias Criadas vs Resolvidas — <span id="tituloAno">@anoSelecionado</span></h5>
                <canvas id="chartCriadasResolvidas" style="height: 380px;"></canvas>
            </div>
        </div>
    </div>

    <div class="row mt-4">
        <div class="col-md-10 offset-md-1">
            <div class="card p-3 shadow">
                <h5>Denúncias Falsas por Mês — <span id="tituloAnoFalsas">@anoSelecionado</span></h5>
                <canvas id="chartFalsasPorMes" style="height: 380px;"></canvas>
            </div>
        </div>
    </div>

    <div class="row mt-4">
        <div class="col-md-10 offset-md-1">
            <div class="card p-3 shadow">
                <h5>Média de Tempo de Resolução por Mês (dias) — <span id="tituloAno2">@anoSelecionado</span></h5>
                <canvas id="chartTempoResolucao" style="height: 380px;"></canvas>
            </div>
        </div>
    </div>
</div>

@section Scripts {
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.1/dist/chart.umd.min.js"></script>

    <script>
        // Variáveis globais (Dados iniciais do C#)
        var mensalCriadas = @Html.Raw(JsonSerializer.Serialize(mensalCriadas));
        var mensalResolvidas = @Html.Raw(JsonSerializer.Serialize(mensalResolvidas));
        var mensalFalsas = @Html.Raw(JsonSerializer.Serialize(mensalFalsas));
        var mediaDiasPorMes = @Html.Raw(JsonSerializer.Serialize(mediaDiasPorMes));

        const labelsMeses = ["Jan","Fev","Mar","Abr","Mai","Jun","Jul","Ago","Set","Out","Nov","Dez"];

        // Função para formatar o total de dias decimais em Dias e Horas para o Tooltip
        function formatarDiasParaDiasHoras(totalDias) {
            if (totalDias <= 0) return "N/A";

            const diasTotal = Math.floor(totalDias);
            const fracaoHoras = totalDias - diasTotal;
            // Arredonda para a hora inteira mais próxima (0-23)
            const horasRestantes = Math.round(fracaoHoras * 24);

            let resultado = "";

            if (diasTotal > 0) {
                resultado += `${diasTotal} dia${diasTotal > 1 ? "s" : ""}`;
            }

            if (horasRestantes > 0) {
                if (diasTotal > 0) {
                    resultado += " e ";
                }
                resultado += `${horasRestantes} hora${horasRestantes > 1 ? "s" : ""}`;
            }

            // Caso seja menos de uma hora
            if (diasTotal === 0 && horasRestantes === 0 && totalDias > 0) {
                const minutos = Math.round(totalDias * 24 * 60);
                return minutos > 0 ? `${minutos} min` : "0 min";
            }

            return resultado.trim() || "0 horas";
        }

        // --- CHART 1: CRIADAS/RESOLVIDAS ---
        const ctx1 = document.getElementById('chartCriadasResolvidas').getContext('2d');
        const gradCriadas = ctx1.createLinearGradient(0,0,0,400);
        gradCriadas.addColorStop(0, 'rgba(13,110,253,0.28)');
        gradCriadas.addColorStop(1, 'rgba(13,110,253,0.02)');
        const gradResolvidas = ctx1.createLinearGradient(0,0,0,400);
        gradResolvidas.addColorStop(0, 'rgba(25,135,84,0.28)');
        gradResolvidas.addColorStop(1, 'rgba(25,135,84,0.02)');

        let chartCriadas = new Chart(ctx1, {
            type: 'line',
            data: {
                labels: labelsMeses,
                datasets: [
                    {
                        label: 'Criadas',
                        data: mensalCriadas,
                        borderColor: '#0d6efd',
                        backgroundColor: gradCriadas,
                        fill: true,
                        tension: 0.25,
                        pointRadius: 4
                    },
                    {
                        label: 'Resolvidas',
                        data: mensalResolvidas,
                        borderColor: '#198754',
                        backgroundColor: gradResolvidas,
                        fill: true,
                        tension: 0.25,
                        pointRadius: 4
                    }
                ]
            },
            options: {
                responsive: true,
                interaction: { mode: 'index', intersect: false },
                plugins: { legend: { position: 'top' } },
                scales: { y: { beginAtZero: true } }
            }
        });
        // -----------------------------------------------------------

        // --- CHART 2: DENÚNCIAS FALSAS POR MÊS ---
        const ctxFalsas = document.getElementById('chartFalsasPorMes').getContext('2d');

        let chartFalsas = new Chart(ctxFalsas, {
            type: 'bar',
            data: {
                labels: labelsMeses,
                datasets: [{
                    label: 'Denúncias Falsas',
                    data: mensalFalsas,
                    backgroundColor: 'rgba(220,53,69,0.7)',
                    borderColor: '#dc3545',
                    borderWidth: 1
                }]
            },
            options: {
                responsive: true,
                scales: { y: { beginAtZero: true } },
                plugins: { legend: { position: 'top' } }
            }
        });
        // -----------------------------------------------------------


        // --- CHART 3: TEMPO RESOLUÇÃO ---
        const ctx2 = document.getElementById('chartTempoResolucao').getContext('2d');

        let chartTempo = new Chart(ctx2, {
            type: 'bar',
            data: {
                labels: labelsMeses,
                datasets: [{
                    label: 'Média de Resolução',
                    data: mediaDiasPorMes,
                    backgroundColor: 'rgba(253,126,20,0.85)',
                    borderColor: 'rgba(253,126,20,1)',
                    borderWidth: 1
                }]
            },
            options: {
                responsive: true,
                scales: { y: { beginAtZero: true, title: { display: true, text: 'Média em Dias' } } },
                plugins: {
                    tooltip: {
                        callbacks: {
                            label: function(context) {
                                let label = context.dataset.label || '';
                                if (label) {
                                    label += ': ';
                                }
                                const diasOriginais = context.raw;
                                label += formatarDiasParaDiasHoras(diasOriginais);
                                return label;
                            },
                        }
                    }
                }
            }
        });

        // --- LÓGICA DE ATUALIZAÇÃO AJAX COMPLETA ---
        document.getElementById("btnAtualizar").addEventListener("click", async () => {
            const ano = document.getElementById("selectAno").value;

            try {
                // Chamadas paralelas para obter KPIs e Dados de Gráficos
                const [resKpi, resGraph] = await Promise.all([
                    fetch(`/Denuncia/GetKpiData?ano=${ano}`),
                    fetch(`/Denuncia/GetDashboardData?ano=${ano}`)
                ]);

                if (!resKpi.ok || !resGraph.ok) {
                    throw new Error("Erro ao carregar dados do dashboard.");
                }

                const kpiData = await resKpi.json();
                const graphData = await resGraph.json();

                // ----------------------------------------------------
                // 1. ATUALIZAÇÃO DOS CARDS DE KPI
                // ----------------------------------------------------

                // Card 1: Total de Denúncias (Global)
                document.getElementById('kpi-total-denuncias').innerText = kpiData.totalDenuncias;

                // Card 3: Denúncias no Mês (Atualizado pelo ano)
                document.getElementById('kpi-denuncias-mes').innerText = kpiData.denunciasMes;
                document.getElementById('kpi-denuncias-mes-rodape').innerText = `${new Date().toLocaleString('pt-BR', { month: 'long' })}/${ano}`;

                // Card 4: Tempo Médio de Resolução (Atualizado pelo ano)
                document.getElementById('kpi-tempo-resolucao').innerText = kpiData.mediaTempoDias;

                // ----------------------------------------------------
                // 2. ATUALIZAÇÃO DOS GRÁFICOS
                // ----------------------------------------------------

                // Atualiza variáveis globais de gráficos
                mediaDiasPorMes = graphData.mediaDias;
                mensalFalsas = graphData.falsas;

                // Gráfico Criadas/Resolvidas
                chartCriadas.data.datasets[0].data = graphData.criadas;
                chartCriadas.data.datasets[1].data = graphData.resolvidas;
                chartCriadas.update();

                // Gráfico Denúncias Falsas
                chartFalsas.data.datasets[0].data = graphData.falsas;
                chartFalsas.update();
                document.getElementById("tituloAnoFalsas").innerText = ano;

                // Gráfico Tempo de Resolução
                chartTempo.data.datasets[0].data = graphData.mediaDias;
                chartTempo.update();

                // Atualiza Títulos de Ano
                document.getElementById("tituloAno").innerText = ano;
                document.getElementById("tituloAno2").innerText = ano;

            } catch (error) {
                console.error("Erro na atualização do Dashboard:", error);
                alert("Ocorreu um erro ao carregar os dados. Verifique a console para detalhes.");
            }
        });

        // --- LÓGICA DE EXPORTAÇÃO ---
        document.getElementById('exportCsv').addEventListener('click', () => {
            const ano = document.getElementById('selectAno').value;
            window.location.href = `/Denuncia/ExportCsv?ano=${ano}`;
        });

        document.getElementById('exportExcel').addEventListener('click', () => {
            const ano = document.getElementById('selectAno').value;
            window.location.href = `/Denuncia/ExportExcel?ano=${ano}`;
        });
    </script>
}