@model Farol_Seguro.Models.Denuncia

@{
    ViewData["Title"] = "Detalhes da Denúncia";
    bool isAluno = User.IsInRole("Aluno");
    bool ehGestor = User.IsInRole("Funcionario") || User.IsInRole("Admin");
    bool podeAlunoEditar = isAluno && (Model.Status_Denuncia == "Pendente" || Model.Status_Denuncia == "Aberta");
    string actionVoltar = ehGestor ? "Index" : "MinhasDenuncias";
}

<link href="~/css/header.css" rel="stylesheet" />
<link href="~/css/Details.css" rel="stylesheet" />

<div class="details-container">
    @* Bloco de Mensagens TempData *@
    @{
        if (TempData["MensagemSucesso"] != null)
        {
            <div class="alert alert-success alert-custom alert-dismissible fade show" role="alert">
                <strong><i class="fas fa-check-circle me-2"></i>Sucesso!</strong> @TempData["MensagemSucesso"]
                <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
            </div>
        }
        else if (TempData["MensagemErro"] != null)
        {
            <div class="alert alert-danger alert-custom alert-dismissible fade show" role="alert">
                <strong><i class="fas fa-exclamation-circle me-2"></i>Erro!</strong> @TempData["MensagemErro"]
                <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
            </div>
        }
    }

    @if (Model == null)
    {
        <div class="alert alert-warning">Denúncia não encontrada.</div>
    }
    else
    {
        <!-- Card de Detalhes Principal -->
        <div class="details-card">
            <div class="details-card-header">
                <h2 class="details-card-title">
                    <i class="fas fa-flag"></i>
                    Detalhes da Denúncia #@Model.Id_Denuncia
                </h2>
            </div>
            <div class="details-card-body">
                <ul class="details-list">
                    <li class="detail-item">
                        <div class="detail-icon">
                            <i class="fas fa-hashtag"></i>
                        </div>
                        <div class="detail-content">
                            <div class="detail-label">ID</div>
                            <div class="detail-value">@Model.Id_Denuncia</div>
                        </div>
                    </li>
                    <li class="detail-item">
                        <div class="detail-icon">
                            <i class="fas fa-heading"></i>
                        </div>
                        <div class="detail-content">
                            <div class="detail-label">Título</div>
                            <div class="detail-value">@(Model.Titulo_Denuncia ?? "-")</div>
                        </div>
                    </li>
                    <li class="detail-item">
                        <div class="detail-icon">
                            <i class="fas fa-align-left"></i>
                        </div>
                        <div class="detail-content">
                            <div class="detail-label">Descrição</div>
                            <div class="detail-value">@Model.Descricao_Denuncia</div>
                        </div>
                    </li>
                    <li class="detail-item">
                        <div class="detail-icon">
                            <i class="fas fa-tag"></i>
                        </div>
                        <div class="detail-content">
                            <div class="detail-label">Categoria</div>
                            <div class="detail-value">@Model.Categoria_Denuncia</div>
                        </div>
                    </li>
                    <li class="detail-item">
                        <div class="detail-icon">
                            <i class="fas fa-info-circle"></i>
                        </div>
                        <div class="detail-content">
                            <div class="detail-label">Status</div>
                            <div class="detail-value">@Model.Status_Denuncia</div>
                        </div>
                    </li>
                    <li class="detail-item">
                        <div class="detail-icon">
                            <i class="fas fa-calendar"></i>
                        </div>
                        <div class="detail-content">
                            <div class="detail-label">Data de Criação</div>
                            <div class="detail-value">@Model.DataCriacao_Denuncia.ToString("dd/MM/yyyy HH:mm")</div>
                        </div>
                    </li>
                    <li class="detail-item">
                        <div class="detail-icon">
                            <i class="fas fa-user-graduate"></i>
                        </div>
                        <div class="detail-content">
                            <div class="detail-label">Aluno</div>
                            <div class="detail-value">@(Model.DenunciaAnonima ? "Anônima" : Model.Aluno?.Nome_Aluno ?? "Não informado")</div>
                        </div>
                    </li>
                    <li class="detail-item">
                        <div class="detail-icon">
                            <i class="fas fa-school"></i>
                        </div>
                        <div class="detail-content">
                            <div class="detail-label">Escola</div>
                            <div class="detail-value">@Model.Escola?.Nome_Escola</div>
                        </div>
                    </li>
                </ul>

                <!-- Seção de Anexos -->
                <div class="details-section">
                    <h5 class="details-section-title">
                        <i class="fas fa-paperclip"></i>
                        Anexos
                    </h5>
                    @if (Model.Anexos != null && Model.Anexos.Any())
                    {
                        <div class="attachments-list">
                            @foreach (var a in Model.Anexos)
                            {
                                <div class="attachment-item">
                                    <i class="fas fa-file"></i>
                                    <a href="@a.Caminho_Anexo" target="_blank">@(a.NomeOriginal_Anexo ?? a.Tipo_Anexo)</a>
                                </div>
                            }
                        </div>
                    }
                    else
                    {
                        <p class="text-muted">Sem anexos.</p>
                    }
                </div>

                <!-- Seção de Testemunhas -->
                <div class="details-section">
                    <h5 class="details-section-title">
                        <i class="fas fa-users"></i>
                        Testemunhas
                    </h5>
                    @if (Model.DenunciaTestemunhas != null && Model.DenunciaTestemunhas.Any())
                    {
                        <div class="witnesses-list">
                            @foreach (var dt in Model.DenunciaTestemunhas)
                            {
                                <div class="witness-item">
                                    <strong>@dt.Testemunha?.Nome_Testemunha</strong>
                                    @if (!string.IsNullOrWhiteSpace(dt.Testemunha?.Telefone_Testemunha))
                                    {
                                        <span class="text-muted">- @dt.Testemunha.Telefone_Testemunha</span>
                                    }
                                </div>
                            }
                        </div>
                    }
                    else
                    {
                        <p class="text-muted">Sem testemunhas.</p>
                    }
                </div>

                <!-- Seção de Respostas -->
                <div class="details-section">
                    <h5 class="details-section-title">
                        <i class="fas fa-comments"></i>
                        Respostas
                    </h5>
                    @if (Model.Respostas != null && Model.Respostas.Any())
                    {
                        <div class="responses-list">
                            @foreach (var r in Model.Respostas.OrderBy(r => r.Data_Resposta))
                            {
                                <div class="response-item">
                                    <div class="response-content">@r.Descricao_Resposta</div>
                                    <div class="response-meta">
                                        <small class="text-muted">
                                             <strong>@r.Funcionario?.Nome_Funcionario</strong> -
                                            <i class="fas fa-clock"></i> @r.Data_Resposta.ToString("dd/MM/yyyy HH:mm")
                                        </small>
                                    </div>
                                </div>
                            }
                        </div>
                    }
                    else
                    {
                        <p class="text-muted">Sem respostas.</p>
                    }
                </div>

                <!-- Botões de Ação -->
                <div class="details-actions">
                    <a asp-action="@actionVoltar" class="btn-details btn-back">
                        <i class="fas fa-arrow-left"></i>
                        Voltar
                    </a>
                    
                    @if (podeAlunoEditar || ehGestor)
                    {
                        <a asp-action="Editar" asp-route-id="@Model.Id_Denuncia" class="btn-details btn-edit">
                            <i class="fas fa-edit"></i>
                            Editar Denúncia
                        </a>
                    }
                </div>

                <!-- Formulários para Funcionário/Admin -->
                @if (ehGestor)
                {
                    <!-- Formulário de Resposta -->
                    <div class="details-section">
                        <h5 class="details-section-title">
                            <i class="fas fa-reply"></i>
                            Adicionar Resposta
                        </h5>
                        <form asp-action="Responder" method="post" class="details-form">
                            @Html.AntiForgeryToken()
                            <input type="hidden" name="Id_Denuncia" value="@Model.Id_Denuncia" />
                            <div class="form-group">
                                <textarea name="Descricao_Resposta" class="form-control" rows="3" placeholder="Digite a resposta..." required></textarea>
                            </div>
                            <button type="submit" class="btn-details btn-success">
                                <i class="fas fa-paper-plane"></i>
                                Enviar Resposta
                            </button>
                        </form>
                    </div>

                    <!-- Formulário de Alteração de Status -->
                    <div class="details-section">
                        <h5 class="details-section-title">
                            <i class="fas fa-sync-alt"></i>
                            Alterar Status
                        </h5>
                        <form asp-action="AlterarStatus" method="post" class="details-form">
                            @Html.AntiForgeryToken()
                            <input type="hidden" name="id" value="@Model.Id_Denuncia" />
                            <div class="form-group">
                                <select name="novoStatus" class="form-control" required>
                                    <option value="">-- Selecionar --</option>
                                    <option value="Aberta">Aberta</option>
                                    <option value="Pendente">Pendente</option>
                                    <option value="Em Análise">Em Análise</option>
                                    <option value="Respondida">Respondida</option>
                                    <option value="Resolvida">Resolvida</option>
                                    <option value="Encerrada">Encerrada</option>
                                </select>
                            </div>
                            <button type="submit" class="btn-details btn-primary">
                                <i class="fas fa-save"></i>
                                Salvar Status
                            </button>
                        </form>
                    </div>
                }
            </div>
        </div>
    }
</div>

<style>
    /* Estilos específicos para a tela de denúncia */
    .details-section {
        margin-top: 30px;
        padding-top: 20px;
        border-top: 1px solid #E2E8F0;
    }

    .details-section-title {
        font-size: 1.2rem;
        font-weight: 600;
        color: #8B0000;
        margin-bottom: 15px;
        display: flex;
        align-items: center;
        gap: 10px;
    }

    .attachments-list,
    .witnesses-list,
    .responses-list {
        display: flex;
        flex-direction: column;
        gap: 10px;
    }

    .attachment-item {
        display: flex;
        align-items: center;
        gap: 10px;
        padding: 8px 12px;
        background: #F7FAFC;
        border-radius: 6px;
        border-left: 3px solid #8B0000;
    }

    .attachment-item i {
        color: #8B0000;
    }

    .witness-item {
        padding: 8px 12px;
        background: #F7FAFC;
        border-radius: 6px;
    }

    .response-item {
        padding: 15px;
        background: #F7FAFC;
        border-radius: 8px;
        border-left: 3px solid #8B0000;
    }

    .response-content {
        margin-bottom: 5px;
    }

    .response-meta {
        font-size: 0.85rem;
    }

    .details-form {
        background: #F7FAFC;
        padding: 20px;
        border-radius: 8px;
    }

    .btn-success {
        background: #28A745;
        color: white;
    }

    .btn-primary {
        background: #8B0000;
        color: white;
    }

    .form-group {
        margin-bottom: 15px;
    }

    .form-control {
        border: 1px solid #ddd;
        border-radius: 6px;
        padding: 10px;
    }

    .alert-custom {
        border-radius: 10px;
        border: none;
        padding: 15px 20px;
        margin-bottom: 25px;
        box-shadow: 0 3px 10px rgba(0, 0, 0, 0.1);
    }

    .alert-success {
        background: linear-gradient(135deg, #d4edda, #c3e6cb);
        color: #155724;
        border-left: 4px solid #28A745;
    }

    .alert-danger {
        background: linear-gradient(135deg, #f8d7da, #f1b0b7);
        color: #721c24;
        border-left: 4px solid #DC3545;
    }
</style>

<script src="~/js/menu_dropdown.js"></script>
<script src="~/js/open-modal.js"></script>
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>