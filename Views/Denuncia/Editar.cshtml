@model Farol_Seguro.Models.Denuncia

@{
    ViewData["Title"] = "Editar Denúncia";
    bool isAluno = User.IsInRole("Aluno");
}

<link href="~/css/header.css" rel="stylesheet" />
<link href="~/css/Form.css" rel="stylesheet" />

<div class="form-container">
    <div class="form-section">
        <h1 class="form-title">Editar Denúncia #@Model.Id_Denuncia</h1>

        @if (TempData["MensagemSucesso"] != null)
        {
            <div class="alert alert-success alert-custom alert-dismissible fade show" role="alert">
                <strong><i class="fas fa-check-circle me-2"></i>Sucesso!</strong> @TempData["MensagemSucesso"]
                <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
            </div>
        }
        else if (TempData["MensagemErro"] != null)
        {
            <div class="alert alert-danger alert-custom alert-dismissible fade show" role="alert">
                <strong><i class="fas fa-exclamation-circle me-2"></i>Erro!</strong> @TempData["MensagemErro"]
                <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
            </div>
        }

        <form asp-action="Editar" enctype="multipart/form-data">
            <input type="hidden" asp-for="Id_Denuncia" />

            @Html.AntiForgeryToken()

            <div class="form-group">
                <label asp-for="Titulo_Denuncia" class="form-label">Título da Denúncia</label>
                <input asp-for="Titulo_Denuncia" class="form-control" />
            </div>

            <div class="form-group">
                <label asp-for="Descricao_Denuncia" class="form-label">Descrição da Denúncia</label>
                <textarea asp-for="Descricao_Denuncia" class="form-control" rows="4"></textarea>
            </div>

            <div class="form-group">
                <label asp-for="Categoria_Denuncia" class="form-label">Categoria</label>
                <input asp-for="Categoria_Denuncia" class="form-control" />
            </div>

            @if (!isAluno)
            {
                <div class="form-row">
                    <div class="form-col">
                        <div class="form-group">
                            <label asp-for="Id_Aluno" class="form-label">Aluno</label>
                            <select asp-for="Id_Aluno" class="form-control" asp-items="ViewBag.Id_Aluno"></select>
                        </div>
                    </div>
                    <div class="form-col">
                        <div class="form-group">
                            <label asp-for="Status_Denuncia" class="form-label">Status</label>
                            <select asp-for="Status_Denuncia" class="form-control" required>
                                <option value="Aberta">Aberta</option>
                                <option value="Investigacao">Investigação</option>
                                <option value="Respondida">Respondida</option>
                                <option value="Resolvida">Resolvida</option>
                                <option value="Encerrada">Encerrada</option>
                            </select>
                        </div>
                    </div>
                </div>
            }
            else
            {
                <input type="hidden" asp-for="Id_Aluno" />
                <input type="hidden" asp-for="Status_Denuncia" />
            }

            <div class="form-group">
                <div class="checkbox-group">
                    <input asp-for="DenunciaAnonima" class="form-check-input" />
                    <label asp-for="DenunciaAnonima" class="form-check-label">Denúncia Anônima</label>
                </div>
            </div>

            <div class="form-group">
                <label asp-for="Id_Escola" class="form-label">Escola</label>
                <select asp-for="Id_Escola" class="form-control" asp-items="ViewBag.Id_Escola"></select>
            </div>

            <hr class="form-section-divider" />

            <h5 class="form-subtitle">
                <i class="fas fa-paperclip"></i>
                Anexos Atuais
            </h5>

            @if (Model.Anexos != null && Model.Anexos.Any())
            {
                <div class="attachments-list">
                    @foreach (var anexo in Model.Anexos)
                    {
                        <div class="attachment-item" id="anexo_@anexo.Id_Anexo">
                            <div class="attachment-info">
                                <i class="fas fa-file-alt"></i>
                                <a asp-action="DownloadAnexo" asp-route-idAnexo="@anexo.Id_Anexo">
                                    @(anexo.NomeOriginal_Anexo ?? "Arquivo Anexado")
                                </a>
                            </div>
                            <button type="button" class="btn-action btn-danger btn-sm" onclick="removerAnexo(@anexo.Id_Anexo, @Model.Id_Denuncia)">
                                <i class="fas fa-times"></i> Remover
                            </button>
                        </div>
                    }
                </div>
            }
            else
            {
                <p class="text-muted">Nenhum anexo enviado anteriormente.</p>
            }

            <div class="form-group">
                <label class="form-label">Adicionar Novos Anexos</label>
                <input type="file" name="novosAnexosArquivos" class="form-control" multiple />
                <div class="form-help">Você pode selecionar múltiplos arquivos</div>
            </div>

            <hr class="form-section-divider" />

            <h5 class="form-subtitle">
                <i class="fas fa-users"></i>
                Testemunhas
            </h5>

            <div id="testemunhasContainer" class="witnesses-container">
                @if (Model.DenunciaTestemunhas != null)
                {
                    foreach (var dt in Model.DenunciaTestemunhas)
                    {
                        <div class="witness-item">
                            <div class="form-row">
                                <div class="form-col">
                                    <input type="text" name="Nome_Testemunha" value="@dt.Testemunha.Nome_Testemunha" class="form-control" placeholder="Nome da testemunha" />
                                </div>
                                <div class="form-col">
                                    <input type="text" name="Telefone_Testemunha" value="@dt.Testemunha.Telefone_Testemunha" class="form-control" placeholder="Telefone" />
                                </div>
                            </div>
                        </div>
                    }
                }
            </div>

            <button type="button" class="btn btn-secondary btn-sm" onclick="adicionarTestemunha()">
                <i class="fas fa-plus"></i> Adicionar Testemunha
            </button>

            <div class="btn-group btn-group-center">
                <button type="submit" class="btn btn-primary">
                    <i class="fas fa-save"></i> Salvar Alterações
                </button>
                <a asp-action="Detalhes" asp-route-id="@Model.Id_Denuncia" class="btn btn-secondary">
                    <i class="fas fa-times"></i> Cancelar
                </a>
            </div>
        </form>
    </div>
</div>

<script>
    function adicionarTestemunha() {
        var container = document.getElementById("testemunhasContainer");
        var div = document.createElement("div");
        div.classList.add("witness-item");
        div.innerHTML = `
            <div class="form-row">
                <div class="form-col">
                    <input type="text" name="Nome_Testemunha" class="form-control" placeholder="Nome da testemunha" />
                </div>
                <div class="form-col">
                    <input type="text" name="Telefone_Testemunha" class="form-control" placeholder="Telefone" />
                </div>
            </div>
        `;
        container.appendChild(div);
    }

    // CORREÇÃO AQUI: Aceitando idDenuncia e ajustando a URL para Query String
    function removerAnexo(idAnexo, idDenuncia) {
        if (!confirm("Tem certeza que deseja remover este anexo?")) return;

        // O Token Antiforgery é necessário para a Action [ValidateAntiForgeryToken]
        const token = document.querySelector('input[name="__RequestVerificationToken"]').value;

        // Passa idAnexo e idDenuncia via Query String
        fetch(`/Denuncia/ExcluirAnexo?idAnexo=${idAnexo}&idDenuncia=${idDenuncia}`, {
            method: 'POST',
            headers: {
                'RequestVerificationToken': token
            }
        })
        .then(r => {
            // Verifica se a resposta HTTP é bem-sucedida (status 200-299)
            if (!r.ok) {
                // Se a action no controller redirecionou com erro, o navegador lida com o redirecionamento.
                // Se o servidor retornar um erro HTTP (ex: 400 ou 500), isso aciona o catch.
                // Aqui, vamos recarregar a página para ver as mensagens de TempData do servidor.
                window.location.reload();
                return;
            }

            // Se foi sucesso (sua Action ExcluirAnexo retorna RedirectToAction),
            // a requisição AJAX na verdade recebe um código de redirecionamento (302)
            // mas o fetch não segue automaticamente o redirecionamento para o GET
            // do Detalhes que teria a mensagem de sucesso no TempData.

            // Para simplificar e mostrar o resultado do backend:
            // Recarrega a página para pegar as mensagens de TempData (Sucesso ou Erro) que o servidor setou.
            window.location.reload();
        })
        .catch(err => {
            // Este catch só é acionado em caso de falha de rede/conexão (não erros lógicos 400/500 do servidor)
            alert("Erro de conexão ao tentar remover o anexo. Tente novamente.");
            console.error("Fetch error:", err);
        });
    }
</script>

<style>
    /* Estilos específicos para a edição de denúncia */
    .attachments-list {
        display: flex;
        flex-direction: column;
        gap: 10px;
        margin-bottom: 20px;
    }

    .attachment-item {
        display: flex;
        justify-content: space-between;
        align-items: center;
        padding: 12px 15px;
        background: #F7FAFC;
        border-radius: 8px;
        border-left: 3px solid #8B0000;
    }

    .attachment-info {
        display: flex;
        align-items: center;
        gap: 10px;
    }

        .attachment-info i {
            color: #8B0000;
        }

    .witnesses-container {
        display: flex;
        flex-direction: column;
        gap: 15px;
        margin-bottom: 15px;
    }

    .witness-item {
        padding: 15px;
        background: #F7FAFC;
        border-radius: 8px;
        border: 1px solid #E2E8F0;
    }

    .alert-custom {
        border-radius: 10px;
        border: none;
        padding: 15px 20px;
        margin-bottom: 25px;
        box-shadow: 0 3px 10px rgba(0, 0, 0, 0.1);
    }

    .alert-success {
        background: linear-gradient(135deg, #d4edda, #c3e6cb);
        color: #155724;
        border-left: 4px solid #28A745;
    }

    .alert-danger {
        background: linear-gradient(135deg, #f8d7da, #f1b0b7);
        color: #721c24;
        border-left: 4px solid #DC3545;
    }
</style>

<script src="~/js/menu_dropdown.js"></script>
<script src="~/js/open-modal.js"></script>
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>